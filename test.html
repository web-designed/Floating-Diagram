<!DOCTYPE html>
<html>
<head>
  <title>SVG Lines</title>
  <script src="jquery.js"></script>
  <link rel="stylesheet" type="text/css" href="methodik.css">

</head>
<body>
  <canvas id="canvas" width="100%" height="100%"></canvas>
  <div id="methodik_container">
    <div class="circle" data-init-x="50" data-init-y="80">
      <div id="inner-0" class="inner" data-connect-to="#inner-1, #inner-2, #inner-3, #inner-4">Design Thinking</div>
    </div>
    <div class="circle" data-init-x="15" data-init-y="50">
      <div id="inner-1" class="inner" data-connect-to="#inner-2">Value Proposition Engineering</div>
    </div>
    <div class="circle" data-init-x="30" data-init-y="20">
      <div id="inner-2" class="inner" data-connect-to="#inner-3">Neuro Marketing</div>
    </div>
    <div class="circle" data-init-x="70" data-init-y="20">
      <div id="inner-3" class="inner" data-connect-to="#inner-4">Business Model Generation</div>
    </div>
    <div class="circle" data-init-x="85" data-init-y="50">
      <div id="inner-4" class="inner">Trend Scouting</div>
    </div>
    <button onClick="cancelAnim();" style="position:absolute; z-index: 2">Cancel</button>
  </div>
</body>

<script>

  $ = jQuery;

  /**************************************************************/
  // setup
  /**************************************************************/

    var animations = ['animation1', 'animation2', 'animation3', 'animation4'],
        circles = $('.circle'),
        canvas  = document.getElementById("canvas"),
        canvas2D  = canvas.getContext("2d")
  
    function init_vars(){
      viewportWidth = $(window).innerWidth();
      viewportHeight = $(window).innerHeight();
      circleWidth  = $('.circle').outerWidth();
    }

    init_vars();


  /**************************************************************/
  // functions
  /**************************************************************/

    function circles_init_position(){

      circles.each(function(){

        var _this = $(this);

        var x       = parseFloat(_this.attr('data-init-x'));
        var y       = parseFloat(_this.attr('data-init-y'));
        var delta   = circleWidth/2;

        _this.css({
          'top': y + 'vh',
          'left': x + 'vw',
        });

      });  
    }

    function canvas_init(){
      canvas.width = viewportWidth;
      canvas.height = viewportHeight; 
    }


    function connect(selectorStart, selectorEnd, diameter){

      var positionStart = $(selectorStart).offset();
      var xStart = positionStart.left + diameter/2;
      var yStart = positionStart.top + diameter/2;
      var positionEnd = $(selectorEnd).offset();
      var xEnd = positionEnd.left + diameter/2;
      var yEnd = positionEnd.top + diameter/2;

      // ---------------------------------------------------------
      //  If distance from circle needed 
      //  https://math.stackexchange.com/questions/175896/finding-a-point-along-a-line-a-certain-distance-away-from-another-point
      // ---------------------------------------------------------
        
        var Dt = diameter/2 + 10; //new distance
        var D  = Math.sqrt( (xEnd - xStart) * (xEnd - xStart) + (yEnd - yStart) * (yEnd - yStart) ); //distance btw. original points
        var t  = Dt/D; //ratio

        xt = ( ( ( 1 - t ) * xStart + t * xEnd ) )
        yt = ( ( ( 1 - t ) * yStart + t * yEnd ) )

        xtt = ( ( ( 1 - t ) * xEnd + t * xStart ) )
        ytt = ( ( ( 1 - t ) * yEnd + t * yStart ) )

        canvas2D.beginPath();
        canvas2D.moveTo(xt,yt);
        canvas2D.lineTo(xtt,ytt);
        canvas2D.stroke();
    }

    window.requestAnimFrame = (function(callback) {
      return  window.requestAnimationFrame || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame || 
              window.oRequestAnimationFrame || 
              window.msRequestAnimationFrame ||
              function(callback) {
                window.setTimeout(callback, 1000 / 60);
              };
    })();

    window.cancelRequestAnimFrame = ( function() {
        return window.cancelAnimationFrame          ||
            window.webkitCancelRequestAnimationFrame    ||
            window.mozCancelRequestAnimationFrame       ||
            window.oCancelRequestAnimationFrame     ||
            window.msCancelRequestAnimationFrame        ||
            clearTimeout
    } )();


    function draw_connections(){

      // clear canvas
      canvas2D.clearRect(0, 0, canvas.width, canvas.height);

      //draw
      circles.find('.inner').each(function(){
        
        var _this     = $(this);
        var thisId    = '#' + _this.attr('id');
        var goTo      = _this.attr('data-connect-to');
        var _diameter = _this.outerWidth();

        if (goTo) {
          var goTo = goTo.split(',');
          var goToLength = goTo.length;

          for (var i = 0; i < goToLength; i++) {
            connect( thisId , goTo[i], _diameter);
          }  
        }
      })

      //repeat since the animation is infinite
      requestAnimFrame(function() {
        draw_connections();
      });
    }

    function animate(){
      circles.each(function(i){
        var randomNr = Math.floor( Math.random() * 4 );
        $(this).addClass(animations[randomNr]);
      })
    }

    function cancelAnim() {
      cancelRequestAnimFrame(function() {
        draw_connections();
      })
    }

  /**************************************************************/
  // on hover
  /**************************************************************/

    circles.on('mouseenter', function(){
      
      console.log('hover');

    })

  /**************************************************************/
  // fire functions
  /**************************************************************/

      canvas_init();
      circles_init_position();  

      setTimeout(function() {
        draw_connections();
        // animate();
      }, 2000);

      $(window).resize(function(){

        // http://editor.javascriptkit.com/?eg=requestanimationframe-demo

        console.log('resized');

        cancelRequestAnimFrame(function() {
          draw_connections();
        })

        canvas2D.clearRect(0, 0, canvas.width, canvas.height);

        // setTimeout(function() {
        //   init_vars();
        //   circles_init_position();
        //   draw_connections();
        // }, 2000);
      });


</script>


</html>